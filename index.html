<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Diagn√≥stico de Fiesta | DJ Ponte</title>
  <meta name="description" content="An√°lisis en 3 minutos para eliminar el riesgo de pifia. Obt√©n tu FiestaScore (0‚Äì100), pack recomendado y protocolo de seguridad." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg0: #030619;
      --bg1: #0b1027;
      --card: #0f1633;
      --line: rgba(255,255,255,.10);
      --txt: #f8fafc;
      --muted: rgba(248,250,252,.70);
      --muted2: rgba(248,250,252,.55);
      --accent: #8b5cf6;
      --accent2: #ec4899;
      --shadow: 0 25px 80px rgba(0,0,0,.55);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      color: var(--txt);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(139,92,246,.22), transparent 60%),
                  radial-gradient(900px 600px at 90% 30%, rgba(236,72,153,.18), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
    }

    .bg-glow {
      position: fixed;
      inset: -200px;
      background: radial-gradient(700px 400px at 50% 20%, rgba(139,92,246,.10), transparent 60%);
      filter: blur(30px);
      pointer-events: none;
      z-index: 0;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 48px;
      position: relative;
      z-index: 1;
    }

    .topbar {
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 10;
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .brand__logo {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #ff003c 0%, #c7003d 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-style: italic;
      color: white;
      font-size: 20px;
      box-shadow: 0 10px 30px rgba(255, 0, 60, 0.3);
    }

    .brand__name {
      font-weight: 800;
      letter-spacing: .6px;
    }

    .brand__tag {
      font-size: 12px;
      color: var(--muted2);
      margin-top: 2px;
    }

    .muted { color: var(--muted2); }

    .topbar__link {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s;
    }

    .topbar__link:hover { color: var(--txt); }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: 22px;
      padding: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .card--inner {
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: 18px;
      border: 1px solid var(--line);
    }

    .hero-title {
      font-size: clamp(44px, 10vw, 92px);
      line-height: 0.95;
      font-weight: 800;
      text-align: center;
      margin: 10px 0 18px;
    }

    .grad {
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .sub {
      color: var(--muted);
      text-align: center;
      max-width: 340px;
      margin: 0 auto 22px;
      font-size: 14px;
      opacity: .85;
    }

    .sub2 {
      color: var(--muted);
      margin: 6px 0 0;
      font-size: 14px;
    }

    .kicker {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      color: rgba(255,255,255,.85);
      font-weight: 700;
      letter-spacing: .4px;
      font-size: 12px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 14px 0 18px;
      justify-content: center;
    }

    .pill {
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      color: rgba(255,255,255,.88);
    }

    .btn {
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--txt);
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
      font-family: inherit;
      font-size: 16px;
    }

    .btn:hover { border-color: rgba(255,255,255,.18); }
    .btn:active { transform: translateY(1px); }

    .btn--primary {
      background: linear-gradient(90deg, rgba(139,92,246,.95), rgba(236,72,153,.95));
      border-color: rgba(255,255,255,.16);
    }

    .btn--ghost { background: rgba(255,255,255,.04); }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }

    .btn--xl {
      padding: 18px 26px;
      font-size: 18px;
      border-radius: 18px;
      display: block;
      margin: 10px auto 0;
      min-width: 260px;
    }

    .fineprint {
      margin: 14px 0 0;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.5;
    }

    .hidden { display: none; }

    .quiz__head, .results__head {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      justify-content: space-between;
    }

    .progress {
      min-width: 160px;
      text-align: right;
    }

    .progress__bar {
      height: 10px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress__fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width 0.3s ease;
    }

    .progress__txt {
      margin-top: 8px;
      color: var(--muted2);
      font-size: 12px;
    }

    .qbox { margin: 16px 0 10px; }
    .qtitle h3 { margin: 0 0 6px; font-size: 18px; }

    .options {
      display: grid;
      gap: 10px;
      margin-top: 12px;
    }

    .opt {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      padding: 12px;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 56px;
    }

    .opt:hover { border-color: rgba(255,255,255,.18); }

    .opt__left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
    }

    .opt__t { font-weight: 700; }
    .opt__s { font-size: 12px; color: var(--muted2); }

    .opt__check {
      width: 22px;
      height: 22px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      display: flex;
      align-items: center;
      justify-content: center;
      color: transparent;
      flex: 0 0 auto;
      transition: all 0.2s ease;
    }

    .opt[data-selected="true"] {
      border-color: rgba(236,72,153,.35);
      background: rgba(236,72,153,.08);
    }

    .opt[data-selected="true"] .opt__check {
      color: rgba(255,255,255,.95);
      border-color: rgba(236,72,153,.35);
      background: rgba(236,72,153,.18);
    }

    .opt input[type="radio"],
    .opt input[type="checkbox"] {
      display: none;
    }

    .opt input[type="text"] {
      display: block;
      width: 100%;
      border: none;
      background: transparent;
      color: var(--txt);
      font-weight: 600;
      font-size: 16px;
      outline: none;
    }

    .opt input[type="text"]::placeholder {
      color: var(--muted2);
      font-weight: 600;
    }

    .nav {
      display: flex;
      gap: 10px;
      justify-content: space-between;
      margin-top: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    @media (min-width: 900px) {
      .grid { grid-template-columns: 1fr 1fr; }
      .panel--wide { grid-column: 1 / -1; }
    }

    .panel {
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px;
      background: rgba(0,0,0,.22);
    }

    .panel h3 {
      margin: 0 0 10px;
      font-size: 14px;
      color: rgba(255,255,255,.9);
      letter-spacing: .3px;
      text-transform: uppercase;
    }

    .score {
      display: flex;
      gap: 14px;
      align-items: center;
    }

    .score__num {
      font-size: 44px;
      font-weight: 800;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-weight: 800;
      font-size: 12px;
    }

    .spark {
      height: 10px;
      margin-top: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(34,197,94,.55), rgba(245,158,11,.55), rgba(239,68,68,.55));
      opacity: .85;
    }

    .pack__name { font-weight: 800; font-size: 18px; }
    .pack__price { color: var(--muted); font-size: 13px; margin-top: 4px; }

    .list {
      margin: 10px 0 0;
      padding-left: 18px;
      color: rgba(255,255,255,.88);
    }

    .list li {
      margin: 6px 0;
      color: rgba(255,255,255,.88);
    }

    .lead {
      margin-top: 14px;
      padding: 16px;
    }

    .form label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: rgba(255,255,255,.85);
    }

    .form input {
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--txt);
      outline: none;
      min-height: 48px;
      font-size: 16px;
    }

    .form input:focus { border-color: rgba(139,92,246,.45); }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    @media (min-width: 700px) {
      .row { grid-template-columns: 1fr 1fr; }
    }

    .row--actions { margin-top: 14px; }

    .check {
      margin-top: 12px;
      flex-direction: row !important;
      align-items: center;
      gap: 10px;
    }

    .check input { width: 18px; height: 18px; }

    .cta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .footer {
      margin-top: 18px;
      color: var(--muted2);
      font-size: 12px;
      text-align: center;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(0,0,0,.7);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(255,255,255,.92);
      opacity: 0;
      transition: all .25s ease;
      z-index: 9999;
    }

    .toast--show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @media (max-width: 700px) {
      .quiz__head, .results__head {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .progress {
        min-width: auto;
        text-align: left;
        width: 100%;
      }
      
      .nav {
        position: sticky;
        bottom: 12px;
        background: rgba(3,6,25,.35);
        backdrop-filter: blur(10px);
        padding: 10px;
        border: 1px solid var(--line);
        border-radius: 18px;
      }
      
      .nav .btn { width: 48%; }
    }

    @media (max-width: 480px) {
      .hero-title { font-size: clamp(42px, 12vw, 86px); }
    }
  </style>
</head>

<body>
  <div class="bg-glow"></div>

  <header class="topbar">
    <div class="brand">
      <div class="brand__logo">dj</div>
      <div class="brand__meta">
        <div class="brand__name">DJPONTE<span class="muted">.com</span></div>
        <div class="brand__tag">Bodas ¬∑ Cumplea√±os ¬∑ Empresa ¬∑ Privados</div>
      </div>
    </div>
    <a class="topbar__link" href="#" id="restartLink">Reiniciar</a>
  </header>

  <main class="wrap">
    <!-- HERO -->
    <section class="card hero" id="hero">
      <h1 class="hero-title">
        ¬øBUSCAS DJ?<br>
        <span class="grad">EVITA UNA FIESTA FR√çA</span><br>
        <span style="font-size:0.65em; font-weight:700;">
          ASEGURA QUE TU EVENTO<br>
          SE RECUERDE DE VERDAD
        </span>
      </h1>
      <p class="sub">Diagn√≥stico profesional en 3 minutos para que tu evento funcione.</p>

      <div class="pill-row">
        <div class="pill">‚è± 3 minutos</div>
        <div class="pill">üéõ FiestaScore (0‚Äì100)</div>
        <div class="pill">üß∞ Pack recomendado</div>
      </div>

      <button class="btn btn--primary btn--xl" id="startBtn">Quiero asegurar mi fiesta</button>
      <p class="fineprint" style="text-align:center; margin-top:10px;">Sin compromiso ¬∑ Resultado inmediato</p>

      <p class="fineprint" style="text-align:center;">
        Informe inmediato en pantalla. Si quieres que te lo enviemos por email/WhatsApp, te lo pedimos al final (opcional).
      </p>
    </section>

    <!-- QUIZ -->
    <section class="card quiz hidden" id="quiz">
      <div class="quiz__head">
        <div>
          <div class="kicker">Diagn√≥stico r√°pido</div>
          <h2>Datos del evento</h2>
          <p class="sub2">Responde como si fuera hoy: as√≠ el informe es preciso.</p>
        </div>
        <div class="progress">
          <div class="progress__bar"><div class="progress__fill" id="progressFill"></div></div>
          <div class="progress__txt"><span id="stepTxt">1</span>/<span id="stepTotal">10</span></div>
        </div>
      </div>

      <div class="qbox" id="qbox"></div>

      <div class="nav">
        <button class="btn btn--ghost" id="backBtn">Atr√°s</button>
        <button class="btn btn--primary" id="nextBtn">Continuar</button>
      </div>

      <p class="fineprint">
        Tip: si el local tiene l√≠mite de dB o hay varias edades, a√±√°delo en el √∫ltimo paso.
      </p>
    </section>

    <!-- RESULTS -->
    <section class="card results hidden" id="results">
      <div class="results__head">
        <div class="kicker">Informe</div>
        <h2 id="reportTitle">Tu diagn√≥stico</h2>
        <p class="sub2" id="reportSubtitle">Recomendaci√≥n para que el evento salga redondo.</p>
      </div>

      <div class="panel panel--wide">
        <h3>Lo que esto significa para tu evento</h3>
        <ul class="list" id="persuasionBox"></ul>
      </div>

      <div class="grid">
        <div class="panel">
          <h3>Tu FiestaScore</h3>
          <div class="score">
            <div class="score__num" id="scoreNum">--</div>
            <div class="score__meta">
              <div class="badge" id="riskBadge">Riesgo</div>
              <div class="muted" id="scoreExplain">‚Äî</div>
            </div>
          </div>
          <div class="spark" aria-hidden="true"></div>
        </div>

        <div class="panel">
          <h3>Pack recomendado</h3>
          <div class="pack">
            <div class="pack__name" id="packName">‚Äî</div>
            <div class="pack__price" id="packPrice">‚Äî</div>
            <ul class="list" id="packList"></ul>
          </div>
        </div>

        <div class="panel panel--wide">
          <h3>Protocolo de seguridad</h3>
          <ul class="list" id="protocolList"></ul>
        </div>
      </div>

      <div class="lead card--inner">
        <h3>¬øTe lo enviamos por email o WhatsApp?</h3>
        <p class="sub2">Opcional. Si lo rellenas, te env√≠o el informe + una propuesta r√°pida.</p>

        <form id="leadForm" class="form">
          <div class="row">
            <label>Nombre
              <input type="text" name="name" placeholder="Tu nombre" autocomplete="name" />
            </label>
            <label>Email
              <input type="email" name="email" placeholder="tu@email.com" autocomplete="email" />
            </label>
          </div>

          <div class="row">
            <label>WhatsApp (opcional)
              <input type="tel" name="whatsapp" placeholder="+34‚Ä¶" autocomplete="tel" />
            </label>
            <label>Provincia / zona (opcional)
              <input type="text" name="zone" placeholder="Ej: A Coru√±a / Pontevedra‚Ä¶" />
            </label>
          </div>

          <label class="check">
            <input type="checkbox" name="consent" />
            Acepto que me contactes para este evento.
          </label>

          <div class="row row--actions">
            <button class="btn btn--ghost" type="button" id="downloadBtn">Descargar informe</button>
            <button class="btn btn--primary" type="submit">Enviar</button>
          </div>

          <div class="muted" id="formMsg" role="status" aria-live="polite"></div>
        </form>
      </div>

      <div class="cta">
        <button class="btn btn--primary" id="ctaBtn">Quiero asegurar mi evento</button>
        <button class="btn btn--ghost" id="shareBtn">Compartir</button>
      </div>

      <p class="fineprint">
        Nota: este diagn√≥stico no compromete nada. Solo sirve para que el d√≠a del evento no haya sorpresas.
      </p>
    </section>

    <footer class="footer">
      <div class="muted">¬© DJ Ponte ‚Äî Bodas ¬∑ Cumplea√±os ¬∑ Eventos de empresa ¬∑ Privados</div>
    </footer>
  </main>

  <script>
    const CONFIG = {
      whatsappNumber: "34669060192",
      brandUrl: "https://djponte.com"
    };

    const $ = sel => document.querySelector(sel);
    const hero = $("#hero"), quiz = $("#quiz"), results = $("#results");
    const startBtn = $("#startBtn"), restartLink = $("#restartLink");
    const backBtn = $("#backBtn"), nextBtn = $("#nextBtn");
    const qbox = $("#qbox"), progressFill = $("#progressFill");
    const stepTxt = $("#stepTxt"), stepTotal = $("#stepTotal");
    const scoreNum = $("#scoreNum"), riskBadge = $("#riskBadge");
    const scoreExplain = $("#scoreExplain"), packName = $("#packName");
    const packPrice = $("#packPrice"), packList = $("#packList");
    const protocolList = $("#protocolList"), persuasionBox = $("#persuasionBox");
    const ctaBtn = $("#ctaBtn"), shareBtn = $("#shareBtn");
    const reportTitle = $("#reportTitle"), reportSubtitle = $("#reportSubtitle");
    const leadForm = $("#leadForm"), formMsg = $("#formMsg");
    const downloadBtn = $("#downloadBtn");

    const state = { step: 0, answers: {}, report: null };

    function radioQ({id, title, desc="", options}) {
      return {id, type:"radio", title, desc, options};
    }
    function multiQ({id, title, desc="", options, max=3}) {
      return {id, type:"multi", title, desc, options, max};
    }
    function textQ({id, title, desc="", placeholder=""}) {
      return {id, type:"text", title, desc, placeholder};
    }

    function baseQuestions() {
      return [
        radioQ({id:"eventType", title:"¬øQu√© tipo de evento est√°s organizando?", desc:"As√≠ afinamos el diagn√≥stico.", options:[
          {v:"boda", t:"Boda"}, {v:"cumple", t:"Cumplea√±os"},
          {v:"empresa", t:"Empresa / cena corporativa"}, {v:"privada", t:"Fiesta privada"}, {v:"otro", t:"Otro"}
        ]}),
        radioQ({id:"guests", title:"¬øCu√°nta gente asistir√° aproximadamente?", options:[
          {v:"<30", t:"Menos de 30"}, {v:"30-60", t:"30‚Äì60"}, {v:"60-100", t:"60‚Äì100"}, {v:">100", t:"M√°s de 100"}
        ]}),
        radioQ({id:"venue", title:"¬øD√≥nde se celebra?", options:[
          {v:"resto", t:"Restaurante"}, {v:"casa", t:"Casa privada"}, {v:"finca", t:"Pazo / finca"},
          {v:"hotel", t:"Hotel"}, {v:"local", t:"Local alquilado"}, {v:"otro", t:"Otro"}
        ]}),
        radioQ({id:"timeline", title:"¬øCu√°ndo ser√° el evento?", desc:"Nos ayuda a medir disponibilidad y urgencia.", options:[
          {v:"cerrada", t:"Ya tengo fecha cerrada"}, {v:"<1m", t:"En menos de 1 mes"},
          {v:"1-3m", t:"En 1‚Äì3 meses"}, {v:">3m", t:"En m√°s de 3 meses"}
        ]}),
        radioQ({id:"musicImportance", title:"Para ti, la m√∫sica en este evento es‚Ä¶", options:[
          {v:"detalle", t:"Un detalle m√°s"}, {v:"importante", t:"Importante, pero no decisiva"},
          {v:"clave", t:"Clave para que el evento funcione"}, {v:"top", t:"Lo m√°s importante del evento"}
        ]}),
        multiQ({id:"worries", title:"¬øQu√© te preocupa m√°s?", desc:"Elige hasta 3.", max:3, options:[
          {v:"no_baila", t:"Que la gente no baile"}, {v:"no_encaja", t:"Que la m√∫sica no encaje con todos"},
          {v:"tecnico", t:"Problemas t√©cnicos (sonido, volumen, cortes)"},
          {v:"ambiente", t:"Que falte ambiente"}, {v:"nada", t:"Nada, conf√≠o en que todo saldr√° bien"}
        ]}),
        radioQ({id:"badParty", title:"¬øHas vivido alguna fiesta que no funcion√≥?", options:[
          {v:"si_incomodo", t:"S√≠, y fue inc√≥modo"}, {v:"si_salvo", t:"S√≠, pero se salv√≥"},
          {v:"no_preocupa", t:"No, pero me preocupa que pase"}, {v:"no", t:"No, nunca"}
        ]}),
        radioQ({id:"expectation", title:"¬øQu√© esperas del DJ?", options:[
          {v:"basico", t:"Que ponga m√∫sica sin complicaciones"}, {v:"animar", t:"Que anime y lea la pista"},
          {v:"ambiente", t:"Que se encargue de todo el ambiente"},
          {v:"seguro", t:"Que sea un seguro total para el evento"}
        ]}),
        radioQ({id:"investment", title:"Para este tipo de evento buscas‚Ä¶", desc:"Sin n√∫meros: solo el enfoque.", options:[
          {v:"sencillo", t:"Algo sencillo, sin complicaciones"},
          {v:"pro", t:"Una fiesta bien montada y sin riesgos"},
          {v:"premium", t:"Que todo funcione perfecto y yo no me preocupe de nada"}
        ]}),
        textQ({id:"note", title:"Un detalle que no pueda fallar (opcional)",
          desc:"Ej: 'm√∫sica 90s', 'varias edades', 'l√≠mite de dB', 'entrada sorpresa'‚Ä¶",
          placeholder:"Escribe aqu√≠‚Ä¶"})
      ];
    }

    function questionsForCurrentState() {
      const qs = baseQuestions();
      const t = state.answers.eventType;
      const inv = qs.find(q => q.id === "investment");
      if (inv && t === "boda") {
        inv.title = "En una boda, la m√∫sica para m√≠ es‚Ä¶";
        inv.desc = "Esto define el nivel real de exigencia (y el tipo de montaje).";
        inv.options = [
          {v:"complemento", t:"Un complemento m√°s"},
          {v:"importante", t:"Importante, pero sin excesos"},
          {v:"clave", t:"Clave para que el d√≠a sea perfecto"}
        ];
      }
      return qs;
    }

    function show(el) { el.classList.remove("hidden"); }
    function hide(el) { el.classList.add("hidden"); }

    function flash(msg) {
      const n = document.createElement("div");
      n.className = "toast";
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(() => n.classList.add("toast--show"), 10);
      setTimeout(() => {
        n.classList.remove("toast--show");
        setTimeout(() => n.remove(), 250);
      }, 2200);
    }

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function resetAll() {
      state.step = 0; state.answers = {}; state.report = null;
      render(); show(hero); hide(quiz); hide(results);
      window.scrollTo({top:0, behavior:"smooth"});
    }

    restartLink.addEventListener("click", e => { e.preventDefault(); resetAll(); });
    startBtn.addEventListener("click", () => {
      hide(hero); show(quiz); hide(results); state.step = 0; render();
      window.scrollTo({top:0, behavior:"smooth"});
    });

    backBtn.addEventListener("click", () => {
      if (state.step > 0) state.step -= 1;
      render();
    });

    nextBtn.addEventListener("click", () => {
      const qs = questionsForCurrentState();
      const q = qs[state.step];
      if (!validateCurrent(q)) return;
      if (state.step < qs.length - 1) {
        state.step += 1; render();
      } else {
        state.report = buildReport(state.answers);
        renderResults(state.report);
        hide(hero); hide(quiz); show(results);
        window.scrollTo({top:0, behavior:"smooth"});
      }
    });

    function validateCurrent(q) {
      const val = state.answers[q.id];
      if (q.type === "text") return true;
      if (q.type === "radio") {
        if (!val) { flash("Selecciona una opci√≥n para continuar."); return false; }
        return true;
      }
      if (q.type === "multi") {
        const arr = Array.isArray(val) ? val : [];
        if (arr.length === 0) { flash("Selecciona al menos una opci√≥n."); return false; }
        return true;
      }
      return true;
    }

    function render() {
      const qs = questionsForCurrentState();
      stepTotal.textContent = String(qs.length);
      stepTxt.textContent = String(state.step + 1);
      const denom = Math.max(1, qs.length - 1);
      progressFill.style.width = `${(state.step / denom) * 100}%`;
      const q = qs[state.step];
      renderQuestion(q);
      backBtn.disabled = state.step === 0;
      nextBtn.textContent = state.step === qs.length - 1 ? "Ver mi diagn√≥stico" : "Continuar";
    }

    function renderQuestion(q) {
      qbox.innerHTML = "";
      const h = document.createElement("div");
      h.className = "qtitle";
      h.innerHTML = `<h3>${esc(q.title)}</h3>` + (q.desc ? `<p class="muted">${esc(q.desc)}</p>` : "");
      qbox.appendChild(h);
      if (q.type === "radio") return renderRadio(q);
      if (q.type === "multi") return renderMulti(q);
      if (q.type === "text") return renderText(q);
    }

    function renderRadio(q) {
      const group = document.createElement("div");
      group.className = "options";
      const selected = state.answers[q.id];
      q.options.forEach(opt => {
        const item = document.createElement("label");
        item.className = "opt";
        item.dataset.selected = String(selected === opt.v);
        const left = document.createElement("div");
        left.className = "opt__left";
        left.innerHTML = `<div class="opt__t">${esc(opt.t)}</div>` + (opt.s ? `<div class="opt__s">${esc(opt.s)}</div>` : "");
        const check = document.createElement("div");
        check.className = "opt__check";
        check.textContent = "‚úì";
        const input = document.createElement("input");
        input.type = "radio"; input.name = q.id; input.value = opt.v;
        input.checked = selected === opt.v;
        input.addEventListener("change", () => {
          state.answers[q.id] = opt.v; render();
        });
        item.appendChild(left); item.appendChild(check); item.appendChild(input);
        group.appendChild(item);
      });
      qbox.appendChild(group);
    }

    function renderMulti(q) {
      const group = document.createElement("div");
      group.className = "options";
      const selected = Array.isArray(state.answers[q.id]) ? state.answers[q.id] : [];
      q.options.forEach(opt => {
        const item = document.createElement("label");
        item.className = "opt";
        item.dataset.selected = String(selected.includes(opt.v));
        const left = document.createElement("div");
        left.className = "opt__left";
        left.innerHTML = `<div class="opt__t">${esc(opt.t)}</div>`;
        const check = document.createElement("div");
        check.className = "opt__check";
        check.textContent = "‚úì";
        const input = document.createElement("input");
        input.type = "checkbox"; input.name = q.id; input.value = opt.v;
        input.checked = selected.includes(opt.v);
        input.addEventListener("change", () => {
          let arr = Array.isArray(state.answers[q.id]) ? [...state.answers[q.id]] : [];
          if (input.checked) {
            if (opt.v === "nada") arr = ["nada"];
            else {
              arr = arr.filter(x => x !== "nada");
              if (!arr.includes(opt.v)) arr.push(opt.v);
            }
          } else arr = arr.filter(x => x !== opt.v);
          if (arr[0] !== "nada" && arr.length > q.max) {
            arr = arr.slice(0, q.max);
            flash(`M√°ximo ${q.max} opciones.`);
          }
          state.answers[q.id] = arr; render();
        });
        item.appendChild(left); item.appendChild(check); item.appendChild(input);
        group.appendChild(item);
      });
      qbox.appendChild(group);
    }

    function renderText(q) {
      const wrap = document.createElement("div");
      wrap.className = "options";
      const ta = document.createElement("input");
      ta.type = "text"; ta.placeholder = q.placeholder || "";
      ta.value = state.answers[q.id] || "";
      ta.addEventListener("input", () => { state.answers[q.id] = ta.value; });
      const label = document.createElement("label");
      label.className = "opt";
      label.style.cursor = "text";
      label.style.display = "block";
      label.appendChild(ta);
      wrap.appendChild(label);
      qbox.appendChild(wrap);
    }

    function buildReport(a) {
      const eventType = a.eventType || "otro";
      let score = 50;
      score += ({detalle:-10, importante:0, clave:10, top:15}[a.musicImportance] ?? 0);
      score += ({basico:-10, animar:5, ambiente:10, seguro:15}[a.expectation] ?? 0);
      score += ({"<30":-5, "30-60":5, "60-100":10, ">100":12}[a.guests] ?? 0);
      score += ({casa:-2, resto:4, local:6, hotel:6, finca:7, otro:4}[a.venue] ?? 0);
      score += ({"<1m":-3, "cerrada":0, "1-3m":4, ">3m":6}[a.timeline] ?? 0);
      const worries = Array.isArray(a.worries) ? a.worries : [];
      if (worries.includes("nada")) score -= 3;
      else score += Math.min(10, worries.length * 3);
      score += ({si_incomodo:6, si_salvo:4, no_preocupa:3, no:0}[a.badParty] ?? 0);
      let investmentFit = 0;
      if (eventType === "boda") {
        investmentFit = ({complemento:-18, importante:0, clave:12}[a.investment] ?? 0);
      } else {
        investmentFit = ({sencillo:-15, pro:6, premium:12}[a.investment] ?? 0);
      }
      score += investmentFit;
      score = clamp(Math.round(score), 0, 100);
      let riskRaw = 40;
      riskRaw += ({"<30":-8, "30-60":4, "60-100":10, ">100":14}[a.guests] ?? 0);
      riskRaw += worries.includes("nada") ? -8 : worries.length * 4;
      riskRaw += ({detalle:-8, importante:0, clave:8, top:12}[a.musicImportance] ?? 0);
      riskRaw += ({casa:0, resto:3, local:4, hotel:4, finca:5, otro:3}[a.venue] ?? 0);
      const risk = clamp(Math.round(riskRaw), 0, 100);
      const riskLevel = risk >= 70 ? "ALTO" : risk >= 45 ? "MEDIO" : "BAJO";
      const {pack, protocol, title, subtitle} = recommendPack({a, score, risk, riskLevel});
      return {
        createdAt: new Date().toISOString(),
        answers: a, score, risk, riskLevel, title, subtitle, pack, protocol
      };
    }

    function recommendPack({a, score, risk, riskLevel}) {
      const eventType = a.eventType || "otro";
      const isWedding = eventType === "boda";
      const isCompany = eventType === "empresa";
      const isLarge = a.guests === ">100" || a.guests === "60-100";
      let packName = "Pack Fiesta Segura";
      let packPrice = "Desde 350‚Ç¨ (3‚Äì4 horas)";
      let items = [
        "DJ profesional (lectura de pista)",
        "Equipo de sonido ajustado al aforo",
        "Plan de energ√≠a y contingencia",
        "Transiciones sin cortes (ritmo)"
      ];
      if (isWedding) {
        packName = score >= 75 ? "Pack Boda Sin Riesgos" : "Pack Boda Esencial (bien ejecutada)";
        packPrice = "Desde 750‚Ç¨ (ceremonia + 4 horas de fiesta)";
        items = [
          "M√∫sica ceremonia + microfon√≠a",
          "Coordinaci√≥n de momentos clave (entrada, corte, etc.)",
          "DJ + sonido de pista (ritmo y lectura)",
          "Plan B t√©cnico (cables / backups)"
        ];
      } else if (isCompany) {
        packName = score >= 75 ? "Pack Empresa Premium" : "Pack Empresa Pro";
        packPrice = "Desde 350‚Ç¨ (3‚Äì4 horas)";
        items = [
          "Ambiente elegante ‚Üí fiesta (transici√≥n controlada)",
          "Volumen adaptado al local y normativa",
          "DJ con lectura de p√∫blico mixto",
          "Equipo de sonido seg√∫n aforo"
        ];
      } else {
        if (score >= 80) {
          packName = "Pack Fiesta Premium";
          items.unshift("Din√°mica de pista (subidas/bajadas controladas)");
        }
      }
      if (isLarge || riskLevel === "ALTO") {
        items.push("Refuerzo de sonido (seg√∫n sala/aforo)");
        items.push("Chequeo previo de ubicaci√≥n y puntos de corriente");
      }
      if (a.venue === "finca" || a.venue === "local") {
        items.push("Control de ac√∫stica / colocaci√≥n de altavoces");
      }
      const protocol = [];
      protocol.push("Checklist previo: m√∫sica, timing, puntos de corriente y normativa del local.");
      protocol.push("Backups: m√∫sica offline + duplicado de control (cero sorpresas).");
      protocol.push("Lectura de pista: cambios por energ√≠a, edades y 'momentos clave'.");
      if (a.worries?.includes?.("tecnico") || a.venue === "finca" || a.venue === "local") {
        protocol.push("Plan t√©cnico: regletas, cableado y seguridad de alimentaci√≥n.");
      }
      if (isWedding) {
        protocol.push("Ceremonia: prueba de micro + se√±ales con oficiante/fot√≥grafo.");
      }
      if (a.worries?.includes?.("no_encaja")) {
        protocol.push("Filtro musical: bloque por edades + hits transversales (sin choques).");
      }
      if (a.worries?.includes?.("no_baila")) {
        protocol.push("Arranque de pista: 3‚Äì5 temas 'rompehielo' seg√∫n perfil de invitados.");
      }
      const title = "Tu diagn√≥stico";
      const subtitle =
        riskLevel === "ALTO"
          ? "Con el montaje y control correctos, esto puede salir MUY bien. La clave es evitar improvisaciones."
          : riskLevel === "MEDIO"
          ? "Tienes buen margen para una gran fiesta, pero hay puntos importantes a cuidar."
          : "Buen perfil: con un DJ que lea la pista, lo normal es que salga redondo.";
      return { title, subtitle, pack: {name:packName, price:packPrice, items}, protocol };
    }

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function renderResults(r) {
      reportTitle.textContent = r.title;
      reportSubtitle.textContent = r.subtitle;
      scoreNum.textContent = String(r.score);
      const badgeText = r.riskLevel === "ALTO" ? "Riesgo ALTO" :
        r.riskLevel === "MEDIO" ? "Riesgo MEDIO" : "Riesgo BAJO";
      riskBadge.textContent = badgeText;
      let explain =
        r.score >= 85 ? "Perfil premium: aqu√≠ lo normal es que la pista se encienda si se dise√±a bien el ritmo." :
        r.score >= 70 ? "Muy buen perfil: con un DJ que lea la pista, el evento se vuelve memorable." :
        r.score >= 55 ? "Buen potencial: con 2‚Äì3 decisiones correctas, la fiesta sube de nivel." :
        "Hay se√±ales de riesgo: conviene ajustar enfoque/montaje para evitar una fiesta fr√≠a.";
      const a = r.answers || {};
      const worries = Array.isArray(a.worries) ? a.worries : [];
      const hooks = [];
      if (worries.includes("no_baila")) hooks.push("Arranque de pista dise√±ado (rompehielo) para que no se quede nadie sentado.");
      if (worries.includes("no_encaja")) hooks.push("Bloques por edades + hits transversales para que TODOS sientan que 'esa es su canci√≥n'.");
      if (worries.includes("tecnico")) hooks.push("Protocolo anti-fallo: backups, cableado y plan B t√©cnico (cero sorpresas).");
      if (worries.includes("ambiente")) hooks.push("Control de energ√≠a: subidas/bajadas para que el ambiente crezca de forma natural.");
      if (worries.includes("nada")) hooks.push("Objetivo: mantener ese 'todo bajo control' y que se note profesional.");
      scoreExplain.textContent = explain;
      packName.textContent = r.pack.name;
      packPrice.textContent = r.pack.price;
      packList.innerHTML = "";
      r.pack.items.forEach(x => {
        const li = document.createElement("li");
        li.textContent = x;
        packList.appendChild(li);
      });
      protocolList.innerHTML = "";
      r.protocol.forEach(x => {
        const li = document.createElement("li");
        li.textContent = x;
        protocolList.appendChild(li);
      });
      if (persuasionBox) {
        persuasionBox.innerHTML = "";
        const bullets = [];
        const eventLabel = {
          boda:"boda", cumple:"cumplea√±os", empresa:"evento de empresa",
          privada:"fiesta privada", otro:"evento"
        }[a.eventType] || "evento";
        bullets.push(`Tu ${eventLabel} tiene un riesgo ${r.riskLevel === "ALTO" ? "alto" : r.riskLevel === "MEDIO" ? "medio" : "bajo"} de que la pista flojee si se improvisa. Con el pack recomendado lo reduces al m√≠nimo.`);
        bullets.push("Resultado real: menos estr√©s para ti y m√°s 'momentos' que la gente recuerda (entrada, subid√≥n, cierre).");
        if (hooks.length) bullets.push(...hooks.slice(0, 2));
        if ((a.timeline || "") === "<1m") bullets.push("Si es en menos de 1 mes, conviene reservar cuanto antes para asegurar disponibilidad.");
        if ((a.timeline || "") === "cerrada") bullets.push("Como ya tienes fecha cerrada, lo ideal es cerrar el montaje para que el local y el timing no te den sorpresas.");
        const cta =
          r.score >= 80 ? "Quiero cerrar fecha y asegurar la fiesta" :
          r.score >= 60 ? "Quiero una propuesta r√°pida para mi evento" :
          "Quiero que revises mi caso y evitar errores";
        ctaBtn.textContent = cta;
        bullets.forEach(b => {
          const li = document.createElement("li");
          li.textContent = b;
          persuasionBox.appendChild(li);
        });
      }
    }

    ctaBtn.addEventListener("click", () => {
      const msg = buildWhatsappMessage(state.report);
      const wa = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(msg)}`;
      window.open(wa, "_blank");
    });

    shareBtn.addEventListener("click", async () => {
      const url = location.href;
      const text = "Acabo de hacer mi diagn√≥stico de fiesta (FiestaScore).";
      try {
        if (navigator.share) {
          await navigator.share({title: document.title, text, url});
        } else if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(url);
          flash("Enlace copiado.");
        } else {
          window.prompt("Copia este enlace:", url);
        }
      } catch {
        window.prompt("Copia este enlace:", url);
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!state.report) return;
      const data = JSON.stringify(state.report, null, 2);
      const blob = new Blob([data], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `FiestaScore-${state.report.score}.json`;
      a.click();
      URL.revokeObjectURL(url);
      flash("Informe descargado");
    });

    function buildWhatsappMessage(report) {
      const r = report || {};
      const a = r.answers || {};
      const eventLabel = {
        boda:"Boda", cumple:"Cumplea√±os", empresa:"Empresa",
        privada:"Fiesta privada", otro:"Evento"
      }[a.eventType] || "Evento";
      const guestsLabel = a.guests || "‚Äî";
      const note = (a.note || "").trim();
      const extra = note ? `\nDetalle: ${note}` : "";
      return `Hola DJ Ponte üëã\nHe hecho el Diagn√≥stico de Fiesta.\n\nEvento: ${eventLabel}\nInvitados: ${guestsLabel}\nFiestaScore: ${r.score ?? "‚Äî"}/100\nPack recomendado: ${r.pack?.name ?? "‚Äî"}\n${extra}\n\n¬øPodemos hablar y asegurar que salga perfecto?`;
    }

    leadForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!state.report) return;
      const fd = new FormData(leadForm);
      const payload = {
        lead: {
          name: (fd.get("name") || "").toString().trim(),
          email: (fd.get("email") || "").toString().trim(),
          whatsapp: (fd.get("whatsapp") || "").toString().trim(),
          zone: (fd.get("zone") || "").toString().trim(),
          consent: fd.get("consent") === "on"
        },
        report: state.report,
        source: {
          page: location.href,
          ref: document.referrer || "",
          userAgent: navigator.userAgent,
          ts: new Date().toISOString()
        }
      };
      if (payload.lead.name === "" && payload.lead.email === "" && payload.lead.whatsapp === "") {
        flash("Si quieres que te contacte, deja al menos email o WhatsApp.");
        return;
      }
      if (!payload.lead.consent) {
        flash("Marca la casilla de consentimiento para que pueda contactarte.");
        return;
      }
      formMsg.textContent = "‚úÖ ¬°Guardado! Te contactar√© pronto.";
      console.log("Lead capturado:", payload);
    });

    render();
  </script>
</body>
</html>